<% key=attribute.title %>

<%= folding_panel(attribute.label, collapsed, :body_options => {:id => key }) do %>
  <div id="<%= key %>">
    <div class="table" id="<%= key.singularize %>-table">
      <% if value.blank? %>
        <%= render :partial => "custom_metadata/single_row",
                   :locals=> {:id=>nil, :index => 0, :resource=>resource, :attribute => attribute,:element_name => element_name,:element_class => element_class} %>
      <% else %>
        <% value.each_with_index do |cm_id, index| %>
          <%= render :partial => 'custom_metadata/single_row', :locals=> {:id=> cm_id, :key => key, :index => index,:resource=>CustomMetadata.find(cm_id),
                                                                          :attribute => attribute,:element_name => element_name,:element_class => element_class} %>
        <% end %>
      <% end %>

      <div id="<%= key.singularize %>-row">
        <div colspan="6">
          <%= button_link_to('Add more', 'add', '#', :id => "add-#{key.singularize}-row") %>
        </div>
      </div>
    </div>

    <div id="new-<%= key.singularize %>-row" style="display: none">
      <%= render :partial => 'custom_metadata/single_row', :locals=> {:id=>nil, :resource=>resource, :attribute => attribute,:element_name => element_name,:element_class => element_class} %>
    </div>
  </div>
<% end %>
<script>
    $j(document).ready(function () {

        $j('#add-<%= key.singularize %>-row').click(function () {
            var newRow = $j('#new-<%= key.singularize %>-row').clone().html();
            var index = 0;
            $j('#<%= key.singularize %>-table div.<%= key.singularize %>').each(function () {
                var newIndex = parseInt($j(this).data('index'));
                if (newIndex > index) {
                    index = newIndex;
                }
            });
            index++;
            newRow = newRow.replace(/row-template/g, index);

            $j('#<%= key.singularize %>-table #<%= key.singularize %>-row').before($j(newRow));
            return false;
        });

        $j('#<%= key.singularize %>-table').on('change', '.destroy-row', function () {
            var row = $j(this).parents('.single-role');
            row.remove();
        });
    });


</script>
