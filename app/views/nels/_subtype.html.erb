<i>Non Working prototype, links not working!!</i>
<p><% @file_list -%></p>
<h2>You are at:</h2>

<%# Use @path to create a series of folder links as breadcrumb %>
<%# Remove the first "Storebioinfo/" item and only make elements beyond project clickable%>
<% full_path="Storebioinfo"%>
<p>
  <% @path.split('/')[1..].each_with_index do |path_item, index | %>
    <% full_path += "/"+ path_item %>
    /<span <% if index>1 %> class="nels-folder" style="cursor: pointer;color:blue;"<% end %> path=<%= full_path%>>
      <%= path_item %>
    </span>
  <% end %>
</p>



<% if @dataset['owner_name'].present? %>
    <strong>Owner:</strong> <%= @dataset['owner_name'] %><br/>
<% end %>
<% if (time = Time.parse(@dataset['creation_date']) rescue nil).present? %>
    <strong>Created:</strong> <%= time %> <span class="subtle">(<%= time_ago_in_words(time) %> ago)</span><br/>
<% end %>
<br/>

<style>
table, th, td {
  border:1px solid black;
  border-collapse: collapse;
}
</style>

<%= button_link_to('New Folder', 'add', nil, { id: "", class:"add_metadata"}) %>
<%= button_link_to('Upload', 'arrow_up', nil, { id: "", class:"upload_file"}) %>

<table class="table table-hover table-bordered">
  <thead>
    <tr>
      <th>Name</th>
      <th>Size</th>
    </tr>
  </thead>
  <tbody>
    <% @file_list.each do |file_item| %>
      <tr>
        <td>
          <%= icon_link_to('', 'big_download', {:action => :download_file,
            :project_id => @project_id, :dataset_id => @dataset_id ,:subtype_name => @subtype,:path => file_item["path"] }, method: :get) %>
            <%= file_item["name"]%>
          </span>
          <span style="float: right;"> <%= icon_link_to('Open in NeLS', 'git_repository_search', 'https://test-fe.cbu.uib.no/nels-web/#/sbi-storage',options = {target:'blank'})
          %></span>
        </td>
        <td><%= file_item["size"]%></td>
      </tr>
    <% end %>
  </tbody>
</table>

<%= modal(id: 'upload-file', size: 'm', class: 'text-left') do %>
  <%= form_tag({:action => :upload_file}, :multipart => true) do %>
    <%= modal_header('Upload file') %>
    <%= modal_body do %>
      <%= render :partial=>"assets/upload_box",:locals=>{:resource=>@data_file, :action_text=>"upload"} -%>
    <% end %>
    <%= modal_footer do %>
      <%= create_button id:"data_file_submit_btn", button_text:'Add',
                          onclick:"return validateResourceFields('data_file');",
                          class:'btn btn-primary' %>
      <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
    <% end %>
  <% end %>
<% end %>

<script type="text/javascript">
  $j(document).ready(function () {

    sessionStorage.setItem('nels_folder_state','Folder 1/Folder 2')
    // Update breadcrumb
    pathHTML='';
    path=''
    sessionStorage.getItem('nels_folder_state').split("/").forEach(element => {
      path=path.concat(`/${element}`);
      pathHTML=pathHTML.concat(`/<a href="" onclick="return false;" path="${path}">${element}</a>`);
    });
    $j('#nels_breadcrumb').html(pathHTML)

    function updateFolderList(path){
      $j('#nels-dataset').html('').spinner('add').show();
      $j.ajax({ url: '<%= subtype_nels_path(:assay_id=>params[:assay_id]) -%>',
        data: {
          project_id: '<%= @project_id -%>',
          dataset_id: '<%= @dataset['id'] -%>',
          subtype: '<%= @subtype -%>',
          path: path,
        },
        success: function (data) {
          $j('#nels-dataset').html(data).spinner('remove');
        }
      });
    }

    $j('.nels-folder').click(function() {
      updateFolderList($j(this).attr('path'));
    });

    $j('.upload_file').on('click', function () {
      // Show upload file form and populate the params as hidden fields
      $j('#upload-file').modal('show');
      button_id = $j(this).attr('id')

      $j('#upload-file form').append(`<input type="hidden" name="project_id" value="<%= @project_id %>" />`);
      $j('#upload-file form').append(`<input type="hidden" name="dataset_id" value="<%= @dataset_id %>" />`);
      $j('#upload-file form').append(`<input type="hidden" name="subtype_name" value="<%= @subtype %>" />`);
      $j('#upload-file form').append(`<input type="hidden" name="file_path" value="<%= @path %>" />`);
      return false;
    });
  });
</script>
