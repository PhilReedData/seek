
<h2>
  <span class="<%= nels_subtype_glyph %>"/>
  &nbsp;
  Subtype: <%= @subtype -%><br/>
</h2>

<p>
  <label>Associated NeLS Project:</label>
  <%= link_to(@project['name'], '#', {'data-role':'nels-tree-node-link', 'data-tree-node-id':"project#{@project['id']}"}) %>
</p>
<p>
  <label>Associated Dataset:</label>
  <%= link_to(@dataset['name'], '#', {'data-role':'nels-tree-node-link', 'data-tree-node-id':"dataset#{@dataset['id']}"}) %>
</p>

<style>
table, th, td {
  border:1px solid black;
  border-collapse: collapse;
}
</style>

<p>
  <%= button_link_to('Upload', 'arrow_up', nil, { id: :upload_file, class: :upload_file}) %>
</p>

<table class="table table-hover table-bordered">
  <thead>
    <tr>
      <th>Name</th>
      <th>Size</th>
    </tr>
  </thead>
  <tbody>
    <% @file_list.each_with_index do |file_item, index| %>
      <% next if file_item['isFolder'] %>
      <tr>
        <td>
            <%= file_type_icon_for_filename(file_item["name"]) %>
            <%= file_item["name"] %>
          </span>
          <span style="float: right;">
            <%= icon_link_to('', 'download','#',{ class:'nels-download-link','data-index':index }) %>
          </span>
        </td>
        <td><%= number_to_human_size(file_item["size"]) %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<%= modal(id: 'upload-file', size: 'm', class: 'text-left') do %>
  <%= form_tag({:action => :upload_file}, :multipart => true) do %>
    <%= modal_header('Upload file') %>
    <%= modal_body do %>
      <%= render :partial=>"assets/upload_box",:locals=>{:action_text=>"upload"} -%>
    <% end %>
    <%= modal_footer do %>
      <%= create_button id:"file_submit_btn", button_text:'Add',
                          onclick:"return validateResourceFields('data');",
                          class:'btn btn-primary' %>
      <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
    <% end %>
  <% end %>
<% end %>

<%= content_tag(:script, nels_file_details_json(@file_list, @subtype).to_json.html_safe, type: 'application/json', id: 'file-items-json') %>

<script type="text/javascript">

  function updateFolderList(path){
      $j('#nels-dataset').html('').spinner('add').show();
      $j.ajax({ url: '<%= subtype_nels_path(:assay_id=>params[:assay_id]) -%>',
          data: {
              project_id: '<%= @project_id -%>',
              dataset_id: '<%= @dataset['id'] -%>',
              subtype: '<%= @subtype -%>',
              path: path,
          },
          success: function (data) {
              $j('#nels-dataset').html(data).spinner('remove');
          }
      });
  }

  $j(document).ready(function () {

    sessionStorage.setItem('nels_folder_state','Folder 1/Folder 2')
    // Update breadcrumb
    pathHTML='';
    path=''
    sessionStorage.getItem('nels_folder_state').split("/").forEach(element => {
      path=path.concat(`/${element}`);
      pathHTML=pathHTML.concat(`/<a href="" onclick="return false;" path="${path}">${element}</a>`);
    });
    $j('#nels_breadcrumb').html(pathHTML)

    $j('.nels-folder').click(function() {
      updateFolderList($j(this).attr('path'));
    });

    $j('#upload_file').on('click', function () {
      // Show upload file form and populate the params as hidden fields
      $j('#upload-file').modal('show');
      button_id = $j(this).attr('id')

      $j('#upload-file form').append(`<input type="hidden" name="project_id" value="<%= @project_id %>" />`);
      $j('#upload-file form').append(`<input type="hidden" name="dataset_id" value="<%= @dataset_id %>" />`);
      $j('#upload-file form').append(`<input type="hidden" name="subtype_name" value="<%= @subtype %>" />`);
      $j('#upload-file form').append(`<input type="hidden" name="file_path" value="<%= @path %>" />`);
      return false;
    });

      $j('.nels-download-link').on('click', function () {
          var index = $j(this).data('index');
          var json = JSON.parse($j('#file-items-json').html());
          json = json[index];
          var element = $j(this);
          element.spinner('add');
          $j.ajax({
              url: '<%= download_file_nels_path() %>',
              data: {
                  project_id: json['project_id'],
                  dataset_id: json['dataset_id'],
                  subtype_name: json['subtype_name'],
                  path: json['path'],
                  filename: json['filename']
              },
              success: function (data) {
                  let download_url = `<%= fetch_file_nels_path %>`;
                  download_url = download_url + '?' + $j.param(data)
                  const a = document.createElement('a');
                  a.style.display = 'none';
                  a.href = download_url;
                  a.download = data['filename'];
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
              },
              error: function(request, status, error) {
                  let exception = request.responseJSON['exception'];
                  alert('Something went wrong interacting with NeLS, please try again later. ('+exception+')');
              },
              complete: function(data) {
                  element.spinner('remove');
              }
          });
      });

      bindNelsTreeNodeLinks();

  });
</script>
